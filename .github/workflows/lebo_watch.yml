name: Lebo Watch â€” Weekly Digest

on:
  schedule:
    # Sundays at 7am ET (12:00 UTC)
    - cron: "0 12 * * 0"
  workflow_dispatch: # Allow manual runs

env:
  PYTHONPATH: scripts

permissions:
  contents: write

jobs:
  lebo-watch:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Cloudflare WARP (avoid YouTube IP blocks)
        run: |
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update && sudo apt-get install -y cloudflare-warp
          sudo systemctl start warp-svc
          warp-cli --accept-tos registration new
          warp-cli --accept-tos mode warp
          warp-cli --accept-tos connect
          sleep 3
          curl -s https://www.cloudflare.com/cdn-cgi/trace/ | grep warp

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium --with-deps

      - name: Run data ingestion
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python scripts/ingest_data.py

      - name: Run analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python scripts/analyze_meeting.py

      - name: Publish to Ghost
        env:
          GHOST_API_URL: ${{ secrets.GHOST_API_URL }}
          GHOST_ADMIN_KEY: ${{ secrets.GHOST_ADMIN_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python scripts/publish_to_ghost.py

      - name: Commit and push drafts
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/drafts/
          git diff --cached --quiet || git commit -m "Add weekly digest draft [skip ci]"
          git push

      - name: Upload transcripts as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: transcripts-${{ github.run_id }}
          path: data/transcripts/
          retention-days: 30

      - name: Upload agendas and minutes as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agendas-minutes-${{ github.run_id }}
          path: |
            data/agendas/
            data/minutes/
          retention-days: 30

      - name: Upload budget data as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: budget-${{ github.run_id }}
          path: data/budget/
          retention-days: 30

      - name: Upload drafts as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drafts-${{ github.run_id }}
          path: data/drafts/
          retention-days: 30
