name: Lebo Watch â€” Weekly Digest

on:
  schedule:
    # Sundays at 7am ET (12:00 UTC)
    - cron: "0 12 * * 0"
  workflow_dispatch: # Allow manual runs

env:
  PYTHONPATH: scripts

jobs:
  lebo-watch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium --with-deps

      - name: Run data ingestion
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python scripts/ingest_data.py

      - name: Run analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python scripts/analyze_meeting.py

      - name: Publish to Ghost
        env:
          GHOST_API_URL: ${{ secrets.GHOST_API_URL }}
          GHOST_ADMIN_KEY: ${{ secrets.GHOST_ADMIN_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: python scripts/publish_to_ghost.py

      - name: Upload transcripts as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: transcripts-${{ github.run_id }}
          path: data/transcripts/
          retention-days: 30

      - name: Upload agendas and minutes as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agendas-minutes-${{ github.run_id }}
          path: |
            data/agendas/
            data/minutes/
          retention-days: 30

      - name: Upload budget data as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: budget-${{ github.run_id }}
          path: data/budget/
          retention-days: 30

      - name: Upload drafts as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drafts-${{ github.run_id }}
          path: data/drafts/
          retention-days: 30
